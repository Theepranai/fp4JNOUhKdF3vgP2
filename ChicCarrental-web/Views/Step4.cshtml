@inherits UmbracoViewPage<ChicCarrental_Models.PageModel.Step4Model>
@using System.Security.Cryptography;
@using System.Text;
@{
    Layout = "Master.cshtml";
    var trans = Model.Transection;
}

<div class="container breadcrub">
    <div>
        <p></p>
    </div>
    <div class="clearfix"></div>
    <div class="brlines"></div>
</div>

@functions {

    private static string hmacSHA256(String data, String key)
    {
        using (HMACSHA256 hmac = new HMACSHA256(Encoding.ASCII.GetBytes(key)))
        {
            byte[] a2 = hmac.ComputeHash(Encoding.ASCII.GetBytes(data));
            string a3 = Convert.ToBase64String(a2).ToString().Replace("+", "-").Replace("/", "_").Replace("=", "");
            return a3;
        }
    }

    private static string HMACSHA1(string dataToSign, string key)
    {
        Byte[] secretBytes = UTF8Encoding.UTF8.GetBytes(key);
        HMACSHA1 hmac = new HMACSHA1(secretBytes);

        Byte[] dataBytes = UTF8Encoding.UTF8.GetBytes(dataToSign);
        Byte[] calcHash = hmac.ComputeHash(dataBytes);
        String calcHashString = Convert.ToBase64String(calcHash);
        return calcHashString;
    }

    private static string HashString(string StringToHash, string HachKey)
    {
        System.Text.UTF8Encoding myEncoder = new System.Text.UTF8Encoding();
        byte[] Key = myEncoder.GetBytes(HachKey);
        byte[] Text = myEncoder.GetBytes(StringToHash);
        System.Security.Cryptography.HMACSHA1 myHMACSHA1 = new System.Security.Cryptography.HMACSHA1(Key);
        byte[] HashCode = myHMACSHA1.ComputeHash(Text);
        string hash = BitConverter.ToString(HashCode).Replace("-", "");
        return hash.ToLower();
    }

    public static string hash_hmac_sha1(string message, string key)
    {
        byte[] keyByte = UTF8Encoding.UTF8.GetBytes(key);

        HMACSHA1 hmacsha1 = new HMACSHA1(keyByte);

        byte[] messageBytes = UTF8Encoding.UTF8.GetBytes(message);

        byte[] hashmessage = hmacsha1.ComputeHash(messageBytes);

        string calcHashString = ByteToString(hashmessage);
        return calcHashString.ToLower();
    }

    /*converts byte to encrypted string*/
    public static string ByteToString(byte[] buff)
    {
        string sbinary = "";

        for (int i = 0; i < buff.Length; i++)
        {
            sbinary += buff[i].ToString("X2"); // hex format
        }
        return (sbinary);
    }

}

@if (trans.Payment_Type == "N" && trans.Status == "P" && (DateTime.Now - trans.Add_Date).Hours <= 2)
{

    var merchant_id = "JT01";
    var secret_key = "7jYcp4FxFdf0";

    var payment_description = Model.Car.name + " x " + trans.Numdate + " Day(s)";
    var order_id = Convert.ToInt32(string.Format("10{0}", trans.ID.ToString("D8")));
    var currency = "764";
    var amonutx = Convert.ToInt32(trans.Total_Price.ToString().Replace(".", ""));
    var amount = amonutx.ToString("D12");

    var version = "7.2";
    var payment_url = "https://demo2.2c2p.com/2C2PFrontEnd/RedirectV3/payment";
    var result_url_1 = string.Format("http://" + Request.Url.Host + "/booking/result?id={0}&payment=2c2p", trans.ID);

    var hparam = string.Format("{0}{1}{2}{3}{4}{5}{6}", version, merchant_id, payment_description, order_id, currency, amount, result_url_1);

    string hash_value = hash_hmac_sha1(hparam, secret_key);

    <form id="myform" method="post" action="@payment_url" style="display:none">
        <input type="hidden" name="version" value="@version" />
        <input type="hidden" name="merchant_id" value="@merchant_id" />
        <input type="hidden" name="currency" value="@currency" />
        <input type="hidden" name="result_url_1" value="@result_url_1" />
        <input type="hidden" name="hash_value" value="@hash_value" />
        <input type="hidden" name="payment_description" value="@payment_description" readonly /><br />
        <input type="hidden" name="order_id" value="@order_id" readonly /><br />
        <input type="hidden" name="amount" value="@amount" readonly /><br />
        <input type="submit" name="submit" value="Confirm" />
    </form>

    <script type="text/javascript">
        document.getElementById('myform').submit.click();
    </script>

}

@if (trans.Status == "A")
{
    <div class="container">
        <div class="container mt25 offset-0">
            <div class="col-md-8 pagecontainer2 offset-0">

                <div class="padding30 grey">
                    <h3>Dear value customer,</h3>
                    <p>
                        Your booking number is #@trans.Payment_Type@trans.Transection_ID . In parallel, we have emailed the details of your booking to your specified email.
                    </p>
                    <p>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If there is any questions or queries, please don not hesitate to contact us at +662-286-6799 or reservations@chiccarrent.com. We are more than happy to assist you with any related concerns. We look forward to serving you soon and wish you have a pleasant trip.
                    </p>
                    <p>Regards,</p>
                    <p><b>Chic Car Rent</b></p>
                </div>

            </div>

            <div class="col-md-4">
              

                <div class="pagecontainer2 needassistancebox">
                    <div class="cpadding1">
                        <span class="icon-help"></span>
                        <h3 class="opensans">Need Assistance?</h3>
                        <p class="size14 grey">Our team is 24/7 at your service to help you with your booking issues or answer any related questions</p>
                        <p class="opensans size30 lblue xslim">1-866-599-6674</p>
                    </div>
                </div><br>

                <div class="pagecontainer2 loginbox">
                    <div class="cpadding1">
                        <span class="icon-lockk"></span>
                        <h3 class="opensans">Log in</h3>
                        <input type="text" class="form-control logpadding" placeholder="Username">
                        <br>
                        <input type="text" class="form-control logpadding" placeholder="Password">
                        <div class="margtop20">
                            <div class="left">
                                <div class="checkbox padding0">
                                    <label>
                                        <input type="checkbox">Remember
                                    </label>
                                </div>
                                <a href="#" class="greylink">Lost password?</a><br>
                            </div>
                            <div class="right">
                                <button class="btn-search5" type="submit" onclick="errorMessage()">Login</button>
                            </div>
                        </div>
                        <div class="clearfix"></div><br>
                    </div>
                </div><br>

            </div>
            <!-- END OF RIGHT CONTENT -->


        </div>


    </div>
}
else if (trans.Status == "P" && trans.Payment_Type == "L")
{
    <div class="container">
        <div class="container mt25 offset-0">
            <div class="col-md-8 pagecontainer2 offset-0">

                <div class="padding30 grey">
                    <h3>Dear value customer,</h3>
                    <p>
                        Your booking number is #@trans.Payment_Type@trans.Transection_ID . In parallel, we have emailed the details of your booking to your specified email.
                    </p>
                    <p>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If there is any questions or queries, please don not hesitate to contact us at +662-286-6799 or reservations@chiccarrent.com. We are more than happy to assist you with any related concerns. We look forward to serving you soon and wish you have a pleasant trip.
                    </p>
                    <p>Regards,</p>
                    <p><b>Chic Car Rent</b></p>
                </div>

            </div>

            <div class="col-md-4">
              
                <div class="pagecontainer2 needassistancebox">
                    <div class="cpadding1">
                        <span class="icon-help"></span>
                        <h3 class="opensans">Need Assistance?</h3>
                        <p class="size14 grey">Our team is 24/7 at your service to help you with your booking issues or answer any related questions</p>
                        <p class="opensans size30 lblue xslim">1-866-599-6674</p>
                    </div>
                </div><br />

                <div class="pagecontainer2 loginbox">
                    <div class="cpadding1">
                        <span class="icon-lockk"></span>
                        <h3 class="opensans">Log in</h3>
                        <input type="text" class="form-control logpadding" placeholder="Username">
                        <br>
                        <input type="text" class="form-control logpadding" placeholder="Password">
                        <div class="margtop20">
                            <div class="left">
                                <div class="checkbox padding0">
                                    <label>
                                        <input type="checkbox">Remember
                                    </label>
                                </div>
                                <a href="#" class="greylink">Lost password?</a><br>
                            </div>
                            <div class="right">
                                <button class="btn-search5" type="submit" onclick="errorMessage()">Login</button>
                            </div>
                        </div>
                        <div class="clearfix"></div><br>
                    </div>
                </div><br>

            </div>
            <!-- END OF RIGHT CONTENT -->


        </div>


    </div>
}
else
{
    <section class="row">
        <div class="jumbotron">
            <h1>Payment Fail</h1>
            <p>This example is a quick exercise to illustrate how the default, static and fixed to top navbar work. It includes the responsive CSS and HTML, so it also adapts to your viewport and device.</p>
            <p>To see the difference between static and fixed top navbars, just scroll.</p>
            <p>
                <a class="btn btn-lg btn-primary" href="#" role="button">< back</a>
            </p>
        </div>
    </section>
}

@Html.Partial("~/views/partials/footer.cshtml")